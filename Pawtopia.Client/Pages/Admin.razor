@page "/admin"
@inject HttpClient Http

<h3>Quản lý Đơn Hàng</h3>

<div class="toolbar">
    <input class="form-control"
           placeholder="Tìm theo khách hàng / mã đơn"
           style="max-width:240px"
           @bind="SearchTerm"
           @bind:event="oninput" />

    <select class="form-select"
            style="max-width:160px"
            @bind="FilterStatus">
        <option value="">Tất cả trạng thái</option>
        @foreach (var s in StatusOptions)
        {
            <option value="@s">@GetStatusLabel(s)</option>
        }
    </select>

    <select class="form-select"
            style="max-width:180px"
            @bind="FilterPaymentStatus">
        <option value="">Tất cả thanh toán</option>
        @foreach (var s in PaymentStatusOptions)
        {
            <option value="@s">@GetPaymentStatusLabel(s)</option>
        }
    </select>
</div>

@if (isLoading)
{
    <p>Đang tải đơn hàng…</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (!FilteredOrders.Any())
{
    <div class="alert alert-warning">Không có đơn hàng</div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Mã</th>
                <th>Khách hàng</th>
                <th>Tổng tiền</th>
                <th>Thanh toán</th>
                <th>Trạng thái</th>
                <th>Ngày tạo</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var o in FilteredOrders)
            {
                <tr>
                    <td>@o.Id</td>
                    <td>@(o.AccountName ?? o.CustomerName)</td>
                    <td>@($"{o.Total:N0} VNĐ")</td>
                    <td>
                        <span class="badge @GetPaymentBadge(o.PaymentStatus)">
                            @GetPaymentStatusLabel(o.PaymentStatus)
                        </span>
                    </td>
                    <td>@GetStatusLabel(o.Status)</td>
                    <td>@o.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        <a class="btn btn-sm paw-btn"
                           href="/admin/orders/@o.Id">
                            Chi tiết
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    // =======================
    // STATE
    // =======================
    private List<OrderDto> orders = new();
    private bool isLoading = true;
    private string? error;

    private string SearchTerm = "";
    private string FilterStatus = "";
    private string FilterPaymentStatus = "";

    // =======================
    // OPTIONS
    // =======================
    private static readonly string[] StatusOptions =
        { "Pending", "Processing", "Shipped", "Completed", "Cancelled" };

    private static readonly string[] PaymentStatusOptions =
        { "Pending", "Paid", "Cancelled" };

    // =======================
    // LIFECYCLE
    // =======================
    protected override async Task OnInitializedAsync()
    {
        await LoadOrdersAsync();
    }

    // =======================
    // DATA
    // =======================
    private async Task LoadOrdersAsync()
    {
        try
        {
            isLoading = true;
            error = null;

            orders = await Http.GetFromJsonAsync<List<OrderDto>>(
                "api/admin/orders"
            ) ?? new();
        }
        catch (Exception ex)
        {
            error = $"Không thể tải đơn hàng: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<OrderDto> FilteredOrders =>
        orders.Where(o =>
            (string.IsNullOrWhiteSpace(SearchTerm)
                || o.AccountName?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true
                || o.CustomerName?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) == true
                || o.Id.ToString().Contains(SearchTerm))
            && (string.IsNullOrEmpty(FilterStatus) || o.Status == FilterStatus)
            && (string.IsNullOrEmpty(FilterPaymentStatus) || o.PaymentStatus == FilterPaymentStatus)
        );

    // =======================
    // LABELS
    // =======================
    private static string GetStatusLabel(string? s) => s switch
    {
        "Pending" => "Chờ xử lý",
        "Processing" => "Đang xử lý",
        "Shipped" => "Đã gửi",
        "Completed" => "Hoàn thành",
        "Cancelled" => "Đã hủy",
        _ => "-"
    };

    private static string GetPaymentStatusLabel(string? s) => s switch
    {
        "Paid" => "Hoàn tất",
        "Pending" => "Chờ xử lý",
        "Cancelled" => "Đã hủy",
        _ => "-"
    };

    private static string GetPaymentBadge(string? s) => s switch
    {
        "Paid" => "bg-success text-white",
        "Pending" => "bg-warning text-dark",
        "Cancelled" => "bg-danger text-white",
        _ => "bg-secondary text-white"
    };

    // =======================
    // DTO
    // =======================
    private sealed class OrderDto
    {
        public int Id { get; set; }
        public string? AccountName { get; set; }
        public string? CustomerName { get; set; }
        public decimal Total { get; set; }
        public string? Status { get; set; }
        public string? PaymentStatus { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}
