@page "/admin/orders/{OrderId}"
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager NavManager

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Chi tiết Đơn hàng #@OrderId</h3>
        <a href="/admin" class="btn btn-secondary">⬅ Quay lại danh sách</a>
    </div>

    @if (isLoading)
    {
        <div class="alert alert-info">⏳ Đang tải dữ liệu từ server...</div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">❌ @errorMessage</div>
    }
    else if (orderDetails is not null)
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="m-0">Sản phẩm đã đặt (@orderDetails.Items.Count)</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in orderDetails.Items)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                @if (!string.IsNullOrEmpty(item.Image))
                                                {
                                                    <img src="@item.Image" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;" onerror="this.src='/images/no-image.png'" />
                                                }
                                                <span class="fw-medium">@item.ProductName</span>
                                            </div>
                                        </td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.Price.ToString("N0") đ</td>
                                        <td class="text-end fw-bold">@item.Total.ToString("N0") đ</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                    <td class="text-end fw-bold text-danger fs-5">
                                        @orderDetails.TotalAmount.ToString("N0") đ
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light fw-bold">Thông tin Giao hàng & Khách hàng</div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="text-muted small">Tên khách hàng</label>
                                <p class="fw-bold">@orderDetails.CustomerName</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Số điện thoại</label>
                                <p>@(string.IsNullOrEmpty(orderDetails.CustomerPhone) ? "---" : orderDetails.CustomerPhone)</p>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label class="text-muted small">Email</label>
                                <p>@(string.IsNullOrEmpty(orderDetails.CustomerEmail) ? "---" : orderDetails.CustomerEmail)</p>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small">Ngày đặt hàng</label>
                                <p>@orderDetails.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="text-muted small">Địa chỉ giao hàng</label>
                            <p class="border p-2 rounded bg-light">@orderDetails.ShippingAddress</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white">
                        Trạng thái Đơn hàng
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Trạng thái hiện tại:</label>
                            <select class="form-select mb-2" @bind="selectedStatus">
                                @foreach (var s in StatusLabels)
                                {
                                    <option value="@s.Key">@s.Value</option>
                                }
                            </select>
                            <button class="btn btn-primary w-100" @onclick="UpdateStatusAsync" disabled>
                                💾 Cập nhật trạng thái (Chưa mở API)
                            </button>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <label class="form-label fw-bold">Thanh toán:</label>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>@GetPaymentStatusLabel(orderDetails.PaymentStatus)</span>
                                <span class="badge @(orderDetails.IsPaid ? "bg-success" : "bg-warning text-dark")">
                                    @(orderDetails.IsPaid ? "Đã thanh toán" : "Chưa thanh toán")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">⚠️ Không tìm thấy đơn hàng.</div>
    }
</div>

@code {
    [Parameter]
    public string OrderId { get; set; } = string.Empty;

    // --- DTO: Phải khớp 100% với JSON trả về từ AdminOrdersController ---
    public class OrderDetailDto
    {
        public string Id { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public string Status { get; set; } = "";
        public string PaymentStatus { get; set; } = "";
        public bool IsPaid { get; set; }

        public string CustomerName { get; set; } = "";
        public string CustomerEmail { get; set; } = "";
        public string CustomerPhone { get; set; } = "";

        public string ShippingAddress { get; set; } = "";

        public decimal TotalAmount { get; set; }
        public List<OrderItemDto> Items { get; set; } = new();
    }

    public class OrderItemDto
    {
        public string ProductName { get; set; } = "";
        public decimal Price { get; set; }
        public int Quantity { get; set; }
        public decimal Total { get; set; }
        public string? Image { get; set; } // Link ảnh (ThumbImageLink)
    }
    // -----------------------------------------------------------------

    private OrderDetailDto? orderDetails;
    private bool isLoading = true;
    private string? errorMessage;
    private string? selectedStatus;

    // Mapping hiển thị tiếng Việt
    private readonly Dictionary<string, string> StatusLabels = new()
    {
        { "Pending", "Chờ xác nhận" },
        { "Processing", "Đang xử lý" },
        { "Shipping", "Đang giao hàng" },
        { "Completed", "Hoàn thành" },
        { "Cancelled", "Đã hủy" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadOrderDetailsAsync();
    }

    private async Task LoadOrderDetailsAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // GỌI API THỰC TẾ
            var url = $"api/admin/orders/{OrderId}";
            orderDetails = await Http.GetFromJsonAsync<OrderDetailDto>(url);

            if (orderDetails != null)
            {
                selectedStatus = orderDetails.Status;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi tải dữ liệu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // Helper hiển thị
    private string GetPaymentStatusLabel(string? code) => code switch
    {
        "Paid" => "Đã thanh toán",
        "Pending" => "Chờ thanh toán",
        "Cancelled" => "Đã hủy",
        _ => code ?? "---"
    };

    // Hàm cập nhật (Hiện tại Disable vì chưa có API PUT)
    private async Task UpdateStatusAsync()
    {
        // TODO: Mở comment khi đã viết API PUT cập nhật trạng thái
        // var response = await Http.PutAsJsonAsync($"api/admin/orders/{OrderId}/status", selectedStatus);
        // if (response.IsSuccessStatusCode) { ... }
        await Task.CompletedTask;
    }
}