@page "/Account/Manage/RenamePasskey/{Id}"
@using System.Buffers.Text
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Pawtopia.Data
@using Pawtopia.Models

@inject UserManager<User> UserManager
@inject IdentityRedirectManager RedirectManager

<div class="bg-white shadow sm:rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <EditForm Model="Input" OnValidSubmit="Rename" FormName="rename-passkey" method="post" class="max-w-md space-y-6">
            <DataAnnotationsValidator />
            
            <div>
                 @if (passkey?.Name is { } name)
                {
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Đổi tên Passkey "@name"</h3>
                }
                else
                {
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Đặt tên cho Passkey</h3>
                }
                <div class="mt-2 text-sm text-gray-500">Nhập tên mới dễ nhớ cho khóa bảo mật này.</div>
            </div>

            <div>
                <label for="Input.Name" class="block text-sm font-medium leading-6 text-gray-900">Tên Passkey</label>
                <div class="mt-2">
                    <InputText @bind-Value="Input.Name" id="Input.Name" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6" aria-required="true" placeholder="Ví dụ: iPhone của tôi" />
                </div>
                <ValidationMessage For="() => Input.Name" class="mt-1 text-sm text-red-600" />
            </div>

            <button type="submit" class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 transition-colors">
                Lưu thay đổi
            </button>
        </EditForm>
    </div>
</div>

@code {
    // ... (Code C# giữ nguyên) ...
     private User? user;
    private UserPasskeyInfo? passkey;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [Parameter]
    public string? Id { get; set; }

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();
        user = (await UserManager.GetUserAsync(HttpContext.User))!;
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        byte[] credentialId;
        try
        {
            credentialId = Base64Url.DecodeFromChars(Id);
        }
        catch (FormatException)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey ID had an invalid format.", HttpContext);
            return;
        }

        passkey = await UserManager.GetPasskeyAsync(user, credentialId);
        if (passkey is null)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey could not be found.", HttpContext);
            return;
        }
    }

    private async Task Rename()
    {
        passkey!.Name = Input.Name;
        var result = await UserManager.AddOrUpdatePasskeyAsync(user!, passkey);
        if (!result.Succeeded)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The passkey could not be updated.", HttpContext);
            return;
        }

        RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Passkey updated successfully.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(200, ErrorMessage = "Passkey names must be no longer than {1} characters.")]
        public string Name { get; set; } = "";
    }
}