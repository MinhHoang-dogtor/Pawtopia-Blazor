@page "/Account/Manage/Address"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Pawtopia.Data
@using Pawtopia.Models
@using AddressModel = Pawtopia.Models.Address
@using System.Text.Json.Serialization

@inject UserManager<User> UserManager
@inject PawtopiaDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject HttpClient Http

<PageTitle>Địa chỉ của tôi</PageTitle>

<div class="bg-white shadow-sm rounded-sm p-8 min-h-[500px]">
    <div class="flex justify-between items-center border-b border-gray-100 pb-6 mb-6">
        <h1 class="text-lg font-medium text-gray-900">Địa chỉ của tôi</h1>
        <button @onclick="OpenCreateModal" class="flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Thêm địa chỉ mới
        </button>
    </div>

    @* --- DANH SÁCH ĐỊA CHỈ --- *@
    <div class="space-y-8">
        @if (isLoading)
        {
            <div class="text-center py-10 text-gray-500">Đang tải dữ liệu...</div>
        }
        else if (addresses.Any())
        {
            @foreach (var addr in addresses)
            {
                <div class="flex flex-col sm:flex-row justify-between border-b border-gray-100 pb-6 last:border-0">
                    <div class="flex-1 space-y-2">
                        <div class="flex items-baseline gap-3">
                            <span class="font-medium text-gray-900 text-base">@addr.FullName</span>
                            <span class="text-gray-500 text-sm">@addr.PhoneNumber</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>@addr.AddressLine</p>
                            <p>@addr.Ward, @addr.Province</p>
                        </div>
                        
                        <div class="flex gap-2 mt-3">
                            @if (addr.IsDefault)
                            {
                                <span class="border border-[#ee4d2d] text-[#ee4d2d] text-xs px-2 py-0.5 rounded-sm bg-red-50">Mặc định</span>
                            }
                        </div>
                    </div>

                    <div class="flex flex-col items-end gap-3 mt-4 sm:mt-0">
                        <div class="flex gap-4 text-sm font-medium">
                            <button @onclick="() => OpenEditModal(addr)" class="text-blue-600 hover:underline">Cập nhật</button>
                            @if (!addr.IsDefault)
                            {
                                <button @onclick="() => DeleteAddress(addr)" class="text-blue-600 hover:underline">Xóa</button>
                            }
                        </div>
                        <button @onclick="() => SetDefault(addr)" 
                                disabled="@addr.IsDefault"
                                class="border border-gray-300 text-gray-600 text-sm px-4 py-1.5 rounded-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Thiết lập mặc định
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-10 text-gray-500">Bạn chưa có địa chỉ nào.</div>
        }
    </div>
</div>

@* --- POPUP MODAL --- *@
@if (showModal)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-sm shadow-xl w-full max-w-lg overflow-visible"> @* overflow-visible để hiển thị dropdown *@
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">@(isEditing ? "Cập nhật địa chỉ" : "Địa chỉ mới")</h3>
                <button @onclick="CloseModal" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <EditForm Model="currentAddress" OnValidSubmit="SaveAddress">
                <DataAnnotationsValidator />
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input @bind="currentAddress.FullName" class="w-full px-3 py-2 border rounded-sm focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="Họ và tên" />
                            <ValidationMessage For="() => currentAddress.FullName" class="text-red-500 text-xs mt-1" />
                        </div>
                        <div>
                            <input @bind="currentAddress.PhoneNumber" class="w-full px-3 py-2 border rounded-sm focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="Số điện thoại" />
                            <ValidationMessage For="() => currentAddress.PhoneNumber" class="text-red-500 text-xs mt-1" />
                        </div>
                    </div>

                    @* --- AUTOCOMPLETE TỈNH / THÀNH PHỐ --- *@
                    <div class="relative">
                        <input type="text" 
                               value="@currentAddress.Province"
                               @oninput="OnProvinceInput"
                               @onfocus="() => isProvinceDropdownOpen = true"
                               class="w-full px-3 py-2 border rounded-sm focus:ring-1 focus:ring-indigo-500 outline-none" 
                               placeholder="Nhập tên Tỉnh/Thành phố để tìm..." />
                        
                        @if (isProvinceDropdownOpen && filteredProvinces.Any())
                        {
                            <ul class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                @foreach (var p in filteredProvinces)
                                {
                                    <li @onclick="() => SelectProvince(p)" 
                                        class="px-3 py-2 hover:bg-indigo-50 cursor-pointer text-sm">
                                        @p.Name
                                    </li>
                                }
                            </ul>
                        }
                        <ValidationMessage For="() => currentAddress.Province" class="text-red-500 text-xs mt-1" />
                    </div>

                    @* --- AUTOCOMPLETE PHƯỜNG / XÃ --- *@
                    <div class="relative">
                        <input type="text"
                               value="@currentAddress.Ward"
                               @oninput="OnWardInput"
                               @onfocus="() => isWardDropdownOpen = true"
                               disabled="@(apiWards.Count == 0)"
                               class="w-full px-3 py-2 border rounded-sm focus:ring-1 focus:ring-indigo-500 outline-none disabled:bg-gray-100 disabled:cursor-not-allowed"
                               placeholder="@(apiWards.Count == 0 ? "Vui lòng chọn Tỉnh trước" : "Nhập tên Phường/Xã để tìm...")" />

                        @if (isWardDropdownOpen && filteredWards.Any())
                        {
                            <ul class="absolute z-40 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                @foreach (var w in filteredWards)
                                {
                                    <li @onclick="() => SelectWard(w)"
                                        class="px-3 py-2 hover:bg-indigo-50 cursor-pointer text-sm">
                                        @w.Name
                                    </li>
                                }
                            </ul>
                        }
                        <ValidationMessage For="() => currentAddress.Ward" class="text-red-500 text-xs mt-1" />
                    </div>

                    <div>
                        <textarea @bind="currentAddress.AddressLine" rows="2" class="w-full px-3 py-2 border rounded-sm focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="Địa chỉ cụ thể (Số nhà, tên đường...)"></textarea>
                        <ValidationMessage For="() => currentAddress.AddressLine" class="text-red-500 text-xs mt-1" />
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" @bind="currentAddress.IsDefault" id="isDefault" class="w-4 h-4 text-[#ee4d2d] rounded border-gray-300" />
                        <label for="isDefault" class="text-sm text-gray-600">Đặt làm địa chỉ mặc định</label>
                    </div>
                </div>

                <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3">
                    <button type="button" @onclick="CloseModal" class="px-4 py-2 text-sm border rounded-sm hover:bg-gray-100">Trở lại</button>
                    <button type="submit" class="px-6 py-2 text-sm text-white bg-[#ee4d2d] hover:bg-[#d73211] rounded-sm shadow-sm">Hoàn thành</button>
                </div>
            </EditForm>
        </div>
        
        @* Backdrop trong suốt để đóng dropdown khi click ra ngoài *@
        @if (isProvinceDropdownOpen || isWardDropdownOpen)
        {
            <div class="fixed inset-0 z-30" @onclick="CloseDropdowns"></div>
        }
    </div>
}

@code {
    private List<AddressModel> addresses = new();
    private User? user;
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditing = false;
    private AddressModel currentAddress = new();

    // --- BIẾN API & TÌM KIẾM ---
    private List<ProvinceDto> apiProvinces = new();
    private List<ProvinceDto> filteredProvinces = new(); // Danh sách hiển thị khi tìm
    
    private List<WardDto> apiWards = new();
    private List<WardDto> filteredWards = new(); // Danh sách hiển thị khi tìm

    private bool isProvinceDropdownOpen = false;
    private bool isWardDropdownOpen = false;

    // --- DTO ---
    public class ProvinceDto
    {
        [JsonPropertyName("code")] public int Code { get; set; }
        [JsonPropertyName("name")] public string Name { get; set; } = "";
        [JsonPropertyName("wards")] public List<WardDto>? Wards { get; set; }
    }
    public class WardDto
    {
        [JsonPropertyName("code")] public int Code { get; set; }
        [JsonPropertyName("name")] public string Name { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadApiProvinces();
    }

    private async Task LoadApiProvinces()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<ProvinceDto>>("https://provinces.open-api.vn/api/v2/p/");
            if (result != null) 
            {
                apiProvinces = result;
                filteredProvinces = result; // Mặc định hiển thị hết
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi API Tỉnh: {ex.Message}");
        }
    }

    // --- LOGIC TÌM KIẾM & CHỌN TỈNH ---
    private void OnProvinceInput(ChangeEventArgs e)
    {
        string input = e.Value?.ToString() ?? "";
        currentAddress.Province = input; // Cập nhật text hiển thị
        isProvinceDropdownOpen = true;

        if (string.IsNullOrWhiteSpace(input))
        {
            filteredProvinces = apiProvinces;
        }
        else
        {
            // Lọc không phân biệt hoa thường
            filteredProvinces = apiProvinces
                .Where(p => p.Name.Contains(input, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private async Task SelectProvince(ProvinceDto p)
    {
        currentAddress.Province = p.Name;
        isProvinceDropdownOpen = false; // Đóng dropdown
        
        // Reset Xã
        currentAddress.Ward = "";
        apiWards.Clear();
        filteredWards.Clear();

        // Gọi API lấy Xã
        try 
        {
            var detail = await Http.GetFromJsonAsync<ProvinceDto>($"https://provinces.open-api.vn/api/v2/p/{p.Code}?depth=2");
            if (detail?.Wards != null)
            {
                apiWards = detail.Wards;
                filteredWards = detail.Wards;
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Lỗi API Xã: {ex.Message}");
        }
    }

    // --- LOGIC TÌM KIẾM & CHỌN XÃ ---
    private void OnWardInput(ChangeEventArgs e)
    {
        string input = e.Value?.ToString() ?? "";
        currentAddress.Ward = input;
        isWardDropdownOpen = true;

        if (string.IsNullOrWhiteSpace(input))
        {
            filteredWards = apiWards;
        }
        else
        {
            filteredWards = apiWards
                .Where(w => w.Name.Contains(input, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private void SelectWard(WardDto w)
    {
        currentAddress.Ward = w.Name;
        isWardDropdownOpen = false;
    }

    private void CloseDropdowns()
    {
        isProvinceDropdownOpen = false;
        isWardDropdownOpen = false;
    }

    // --- CRUD DỮ LIỆU ---
    private async Task LoadData()
    {
        isLoading = true;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        user = await UserManager.GetUserAsync(authState.User);
        if (user != null)
        {
            addresses = await DbContext.Addresses
                .Where(a => a.UserId == user.Id)
                .OrderByDescending(a => a.IsDefault)
                .ToListAsync();
        }
        isLoading = false;
    }

    private void OpenCreateModal()
    {
        if (user == null) return;
        isEditing = false;
        currentAddress = new AddressModel { UserId = user.Id };
        
        // Reset Dropdowns
        filteredProvinces = apiProvinces;
        apiWards.Clear();
        filteredWards.Clear();
        CloseDropdowns();
        
        showModal = true;
    }

    private async Task OpenEditModal(AddressModel addr)
    {
        isEditing = true;
        currentAddress = new AddressModel
        {
            Id = addr.Id,
            FullName = addr.FullName,
            PhoneNumber = addr.PhoneNumber,
            Province = addr.Province,
            Ward = addr.Ward,
            AddressLine = addr.AddressLine,
            IsDefault = addr.IsDefault,
            UserId = addr.UserId
        };

        // Logic phục hồi dữ liệu Xã khi sửa
        if (!string.IsNullOrEmpty(currentAddress.Province))
        {
            var p = apiProvinces.FirstOrDefault(x => x.Name == currentAddress.Province);
            if (p != null)
            {
                var detail = await Http.GetFromJsonAsync<ProvinceDto>($"https://provinces.open-api.vn/api/v2/p/{p.Code}?depth=2");
                if (detail?.Wards != null)
                {
                    apiWards = detail.Wards;
                    filteredWards = detail.Wards;
                }
            }
        }
        CloseDropdowns();
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task SaveAddress()
    {
        if (user == null) return;
        // Kiểm tra cơ bản
        if (string.IsNullOrEmpty(currentAddress.Province) || string.IsNullOrEmpty(currentAddress.Ward)) return;

        if (currentAddress.IsDefault)
        {
            var otherDefaults = await DbContext.Addresses
                .Where(a => a.UserId == user.Id && a.IsDefault && a.Id != currentAddress.Id)
                .ToListAsync();
            foreach (var item in otherDefaults) item.IsDefault = false;
        }
        else if (!addresses.Any())
        {
            currentAddress.IsDefault = true;
        }

        if (isEditing) DbContext.Addresses.Update(currentAddress);
        else DbContext.Addresses.Add(currentAddress);

        await DbContext.SaveChangesAsync();
        await LoadData();
        CloseModal();
    }

    private async Task DeleteAddress(AddressModel addr)
    {
        if (addr.IsDefault) return;
        DbContext.Addresses.Remove(addr);
        await DbContext.SaveChangesAsync();
        await LoadData();
    }

    // Đã thêm hàm SetDefault bị thiếu trước đó
    private async Task SetDefault(AddressModel addr)
    {
        if (user == null) return;
        var allAddresses = await DbContext.Addresses.Where(a => a.UserId == user.Id).ToListAsync();
        
        foreach (var item in allAddresses) item.IsDefault = false;
        
        var target = allAddresses.FirstOrDefault(a => a.Id == addr.Id);
        if (target != null)
        {
            target.IsDefault = true;
            await DbContext.SaveChangesAsync();
            await LoadData();
        }
    }
}